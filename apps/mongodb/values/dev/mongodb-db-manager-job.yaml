apiVersion: batch/v1
kind: Job
metadata:
  generateName: mongodb-db-manager-
  namespace: mongodb-dev
  annotations:
    argocd.argoproj.io/hook: Sync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
spec:
  ttlSecondsAfterFinished: 300
  template:
    spec:
      serviceAccountName: mongodb-manager-sa
      initContainers:
      - name: setup-users
        image: mongo:4.4.18
        command:
        - /bin/sh
        - /scripts/setup.sh
        env:
        - name: MONGO_INITDB_ROOT_USERNAME
          valueFrom:
            secretKeyRef:
              name: mongodb-secret
              key: root-username
        - name: MONGO_INITDB_ROOT_PASSWORD
          valueFrom:
            secretKeyRef:
              name: mongodb-secret
              key: root-password
        volumeMounts:
        - name: mongodb-secret-volume
          mountPath: /secrets
        - name: script-volume
          mountPath: /scripts
      containers:
      - name: completion
        image: busybox
        command: ["echo", "Proceso de configuraci√≥n de MongoDB completado"]
      volumes:
      - name: mongodb-secret-volume
        secret:
          secretName: mongodb-credentials
      - name: script-volume
        configMap:
          name: mongodb-user-manager-scripts
          defaultMode: 0755
      restartPolicy: OnFailure
